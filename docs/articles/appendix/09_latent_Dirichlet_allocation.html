<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Section 9: LATENT DIRICHLET ALLOCATION â€¢ diffTop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Section 9: LATENT DIRICHLET ALLOCATION">
<meta property="og:description" content="diffTop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">diffTop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/appendix/01_introduction.html">Section 1: INTRODUCTION</a>
    </li>
    <li>
      <a href="../../articles/appendix/02_microbiome_data.html">Section 2: MICROBIOME DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/03_example_16S_data.html">Section 3: EXAMPLE OF 16S rRNA GENE SEQUENCING DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/04_models.html">Section 4: MODELS</a>
    </li>
    <li>
      <a href="../../articles/appendix/05_transformation.html">Section 5: TRANSFORMATIONS</a>
    </li>
    <li>
      <a href="../../articles/appendix/06_visualization.html">Section 6: VISUALIZATIONS FOR HETEROGENEOUS DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/07_multivariate_and_network_analysis.html">Section 7: MULTIVARIATE AND NETWORK ANALYSES</a>
    </li>
    <li>
      <a href="../../articles/appendix/08_differential_abundance_analysis.html">Section 8: DIFFERENTIAL ABUNDANCE ANALYSIS</a>
    </li>
    <li>
      <a href="../../articles/appendix/09_latent_Dirichlet_allocation.html">Section 9: LATENT DIRICHLET ALLOCATION</a>
    </li>
    <li>
      <a href="../../articles/appendix/10_uncertainity_quan_ordination.html">Section 10: UNCERTAINTY QUANTIFICATION FOR ORDINATION ANALYSIS</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="09_latent_Dirichlet_allocation_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="09_latent_Dirichlet_allocation_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="09_latent_Dirichlet_allocation_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Section 9: LATENT DIRICHLET ALLOCATION</h1>
                        <h4 class="author">Pratheepa Jeganathan</h4>
            
            <h4 class="date">23 February, 2021</h4>
      
      
      <div class="hidden name"><code>09_latent_Dirichlet_allocation.Rmd</code></div>

    </div>

    
    
<p>The input parameters to run this R Markdown are <span class="math inline">\(K\)</span> number of topics and R - number of interations for each Markov chain.</p>
<p>We removed DNA contaminants using BARBI. Then, we choose ASVs that have at least 25 counts in at least two specimens.</p>
<p>In microbiome data, bacteria that have similar functionalities can co-occure as latent communities. In this data set, we are interested infer on the latent communties when we use original and modified PNA clams. To infer about these latent communities, we use topic modeling.</p>
<p>For the topic modeling, we choose Aster-plants. These specimens were sequenced with original and modified pPNA types.</p>
<p>We set the hyper-parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span> less than one to generate mixtures that are different from each other. We choose 0.8 for <span class="math inline">\(\alpha\)</span> across all samples so that we avoid generating unrealistic topics.</p>
<p>We estimate the parameters using HMC NUTS with four chains and 2000 iterations. Out of these 2000 iterations, 1000 iterations were used as warmup samples.</p>
<p>We align the topics from four different chain and compute posterior log likelihood, <span class="math inline">\(\hat{R}\)</span> (split), effective sample size (ESS).</p>
<p>For the model with optimal topic, we do the predictive model check with simulated data, observed data, and a statistic <span class="math inline">\(G\left(K_{ij} \right)\)</span></p>
<p>With the optimal topic, we visualize the topic distribution in each specimen and ASVs distribution in each topic.</p>
<p>With the optimal topic, we do differential topic analysis</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">K</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">K</span>
<span class="va">K</span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">iter</span> <span class="op">&lt;-</span> <span class="va">params</span><span class="op">$</span><span class="va">R</span>
<span class="va">iter</span></code></pre></div>
<pre><code>## [1] 2000</code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://dx.plos.org/10.1371/journal.pone.0061217">phyloseq</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">genefilter</span><span class="op">)</span> <span class="co">#KOverA</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rcpp.org">Rcpp</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan">rstan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">randomcoloR</span><span class="op">)</span><span class="co"># distinctColorPalette(n)</span>

<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu">theme_update</span><span class="op">(</span>
  text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
  legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/genefilter/man/kOverA.html">kOverA</a></span><span class="op">(</span><span class="fl">2</span>, A <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> 
<span class="va">psE_BARBI</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/filter_taxa.html">filter_taxa</a></span><span class="op">(</span>
  <span class="va">psE_BARBI</span>, 
  <span class="va">threshold</span>, <span class="cn">TRUE</span><span class="op">)</span> 

<span class="va">psE_BARBI</span></code></pre></div>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 1418 taxa and 86 samples ]
## sample_data() Sample Data:       [ 86 samples by 16 sample variables ]
## tax_table()   Taxonomy Table:    [ 1418 taxa by 6 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 1418 tips and 1417 internal nodes ]</code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va">psE_BARBI</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">psE_BARBI</span><span class="op">)</span>
<span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/prune_taxa-methods.html">prune_taxa</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/taxa_sums.html">taxa_sums</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">ps</span><span class="op">)</span>
<span class="va">ps</span></code></pre></div>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 1418 taxa and 86 samples ]
## sample_data() Sample Data:       [ 86 samples by 16 sample variables ]
## tax_table()   Taxonomy Table:    [ 1418 taxa by 6 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 1418 tips and 1417 internal nodes ]</code></pre>
<div id="edit-specimen-names" class="section level3">
<h3 class="hasAnchor">
<a href="#edit-specimen-names" class="anchor"></a>Edit specimen names</h3>
<p>We edit specimen names and identify Asteraceae and non-Asteraceae plants.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>, <span class="st">"E106"</span>, <span class="st">"E-106"</span><span class="op">)</span>
<span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">sam_names</span>, <span class="st">"_F_filt.fastq.gz"</span>, <span class="st">""</span><span class="op">)</span>
<span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">sam_names</span>, <span class="st">"Connor-"</span>, <span class="st">"E"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">$</span><span class="va">unique_names</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="va">aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"142"</span>,<span class="st">"143"</span>,<span class="st">"15"</span>,<span class="st">"ST"</span>,<span class="st">"22"</span>,<span class="st">"40"</span><span class="op">)</span>
<span class="va">non_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"33"</span>, <span class="st">"71"</span>, <span class="st">"106"</span><span class="op">)</span>

<span class="va">paired_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E-142-1"</span>, <span class="st">"E142-1"</span>, <span class="st">"E-142-5"</span>, <span class="st">"E142-5"</span>, <span class="st">"E-142-10"</span>, <span class="st">"E142-10"</span>, <span class="st">"E-143-2"</span>, <span class="st">"E143-2"</span>, <span class="st">"E-143-7"</span>, <span class="st">"E143-7"</span>, <span class="st">"E-15-1"</span>, <span class="st">"E15-1"</span>, <span class="st">"ST-CAZ-4-R-O"</span>, <span class="st">"ST-CAZ-4-R-M"</span>, <span class="st">"ST-SAL-22-R-O"</span>, <span class="st">"ST-SAL-22-R-M"</span>, <span class="st">"ST-TRI-10-R-O"</span>, <span class="st">"ST-TRI-10-R-M"</span><span class="op">)</span>
<span class="va">paired_non_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E33-7"</span>, <span class="st">"E-33-7"</span>, <span class="st">"E33-8"</span>, <span class="st">"E-33-8"</span>, <span class="st">"E33-9"</span>, <span class="st">"E-33-9"</span>, <span class="st">"E71-10"</span>, <span class="st">"E-71-10"</span>,<span class="st">"E71-2"</span>,<span class="st">"E-71-2"</span> ,<span class="st">"E71-3"</span>, <span class="st">"E-71-3"</span>, <span class="st">"E106-1"</span>, <span class="st">"E-106-1"</span>, <span class="st">"E106-3"</span>, <span class="st">"E-106-3"</span>, <span class="st">"E106-4"</span>, <span class="st">"E-106-4"</span><span class="op">)</span>
<span class="va">paired_specimens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paired_aster</span>, <span class="va">paired_non_aster</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We will use 9 colors for 9 different plants</span>
<span class="va">plant_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"purple"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="topic-modeling" class="section level2">
<h2 class="hasAnchor">
<a href="#topic-modeling" class="anchor"></a>Topic modeling</h2>
<div id="set-up-data" class="section level3">
<h3 class="hasAnchor">
<a href="#set-up-data" class="anchor"></a>Set-up data</h3>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/get_taxa-methods.html">get_taxa</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="co"># theta[d] ~ dirichlet(alpha), alpha pseudocount for each topic</span>
<span class="co"># beta[k] ~ dirichlet(gamma), gamma pseudocount for each ASV in each topic</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stan.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">K</span>, 
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, 
  D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, 
  n <span class="op">=</span> <span class="va">x</span>, 
  alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.8</span>, <span class="va">K</span><span class="op">)</span>, 
  gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="posterior-sampling" class="section level3">
<h3 class="hasAnchor">
<a href="#posterior-sampling" class="anchor"></a>Posterior sampling</h3>
<p><span class="math inline">\(\theta\)</span> and <span class="math inline">\(B = \left[\beta_{1}, \cdots, \beta_{K} \right]^{T}.\)</span></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fileN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"../results/JABES_Endo_all_K_"</span>,
  <span class="va">K</span>,
  <span class="st">"_ite_"</span>,
  <span class="va">iter</span>,
  <span class="st">".RData"</span>
  <span class="op">)</span>

<span class="va">stan.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan.html">stan</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"./lda.stan"</span>, 
  data <span class="op">=</span> <span class="va">stan.data</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chains <span class="op">=</span> <span class="fl">4</span>, 
  sample_file <span class="op">=</span> <span class="cn">NULL</span>,
  diagnostic_file <span class="op">=</span> <span class="cn">NULL</span>,
  cores <span class="op">=</span> <span class="fl">4</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,
  save_dso <span class="op">=</span> <span class="cn">TRUE</span>,
  algorithm <span class="op">=</span> <span class="st">"NUTS"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">stan.fit</span>, file <span class="op">=</span> <span class="va">fileN</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">fileN</span><span class="op">)</span></code></pre></div>
</div>
<div id="extract-posterior-samples" class="section level3">
<h3 class="hasAnchor">
<a href="#extract-posterior-samples" class="anchor"></a>Extract posterior samples</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span>
  <span class="va">stan.fit</span>, 
  permuted <span class="op">=</span> <span class="cn">TRUE</span>, 
  inc_warmup <span class="op">=</span> <span class="cn">FALSE</span>, 
  include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="co"># samples is a list</span></code></pre></div>
</div>
<div id="alignment" class="section level3">
<h3 class="hasAnchor">
<a href="#alignment" class="anchor"></a>Alignment</h3>
<ul>
<li>Create a Topic <span class="math inline">\(*\)</span> Chain matrix</li>
</ul>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">theta</span> 
<span class="co"># dim(theta)</span>
<span class="va">aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/alignmentMatrix.html">alignmentMatrix</a></span><span class="op">(</span>
  <span class="va">theta</span>, 
  <span class="va">ps</span>, 
  <span class="va">K</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>,
  chain <span class="op">=</span> <span class="fl">4</span>,
  SampleID_name <span class="op">=</span> <span class="st">"unique_names"</span>
  <span class="op">)</span>

<span class="va">theta_aligned</span> <span class="op">&lt;-</span> <span class="fu">thetaAligned</span><span class="op">(</span>
  <span class="va">theta</span>, 
  <span class="va">K</span>, 
  <span class="va">aligned</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chain <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Topic_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># array to a dataframe</span>
<span class="va">theta_all</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
<span class="st">"iteration"</span>, 
<span class="st">"Sample"</span>, 
<span class="st">"Topic"</span>, 
<span class="st">"topic.dis"</span>
<span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"Chain "</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, 
      each <span class="op">=</span> <span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span>

<span class="va">sam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">theta_all</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span>
  <span class="va">theta_all</span>, 
  <span class="va">sam</span>, 
  by <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sample"</span><span class="op">=</span> <span class="st">"unique_names"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">Topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Topic</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">pna</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">pna</span><span class="op">)</span></code></pre></div>
</div>
<div id="plot-the-topic-distribution-in-all-chains" class="section level3">
<h3 class="hasAnchor">
<a href="#plot-the-topic-distribution-in-all-chains" class="anchor"></a>Plot the topic distribution in all chains</h3>
<ul>
<li>facet by pna and aster or non-aster plant type.</li>
<li>In the filtered ps, we have only one aster plant type</li>
</ul>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>theta_summary &lt;-<span class="st"> </span>theta_all <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-2"><a href="#cb20-2"></a><span class="st">  </span><span class="kw">group_by</span>(</span>
<span id="cb20-3"><a href="#cb20-3"></a>    Sample, </span>
<span id="cb20-4"><a href="#cb20-4"></a>    Topic, </span>
<span id="cb20-5"><a href="#cb20-5"></a>    pna</span>
<span id="cb20-6"><a href="#cb20-6"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-7"><a href="#cb20-7"></a><span class="st">  </span><span class="kw">summarize</span>(</span>
<span id="cb20-8"><a href="#cb20-8"></a>    <span class="dt">median.topic.dis =</span> <span class="kw">median</span>(topic.dis)</span>
<span id="cb20-9"><a href="#cb20-9"></a>    ) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-10"><a href="#cb20-10"></a><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb20-11"><a href="#cb20-11"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb20-12"><a href="#cb20-12"></a>    <span class="dt">Topic =</span> <span class="kw">factor</span>(</span>
<span id="cb20-13"><a href="#cb20-13"></a>      Topic, </span>
<span id="cb20-14"><a href="#cb20-14"></a>      <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="kw">str_c</span>(<span class="st">"Topic_"</span>,<span class="dv">1</span><span class="op">:</span>K)</span>
<span id="cb20-15"><a href="#cb20-15"></a>                   )</span>
<span id="cb20-16"><a href="#cb20-16"></a>      )</span>
<span id="cb20-17"><a href="#cb20-17"></a>    )</span>
<span id="cb20-18"><a href="#cb20-18"></a></span>
<span id="cb20-19"><a href="#cb20-19"></a>p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(</span>
<span id="cb20-20"><a href="#cb20-20"></a>  theta_summary, </span>
<span id="cb20-21"><a href="#cb20-21"></a>  <span class="kw">aes</span>(<span class="dt">x =</span> pna, </span>
<span id="cb20-22"><a href="#cb20-22"></a>      <span class="dt">y =</span> Topic,</span>
<span id="cb20-23"><a href="#cb20-23"></a>      <span class="dt">fill =</span> pna)</span>
<span id="cb20-24"><a href="#cb20-24"></a>  )</span>
<span id="cb20-25"><a href="#cb20-25"></a>p &lt;-<span class="st"> </span>p<span class="op">+</span></span>
<span id="cb20-26"><a href="#cb20-26"></a><span class="st">  </span><span class="kw">geom_tile</span>(</span>
<span id="cb20-27"><a href="#cb20-27"></a>    <span class="kw">aes</span>(<span class="dt">alpha =</span> median.topic.dis)</span>
<span id="cb20-28"><a href="#cb20-28"></a>    ) <span class="op">+</span></span>
<span id="cb20-29"><a href="#cb20-29"></a><span class="st">  </span><span class="kw">facet_grid</span>(</span>
<span id="cb20-30"><a href="#cb20-30"></a>    .<span class="op">~</span>Sample,</span>
<span id="cb20-31"><a href="#cb20-31"></a>    <span class="dt">scale =</span> <span class="st">"free"</span></span>
<span id="cb20-32"><a href="#cb20-32"></a>    )<span class="op">+</span></span>
<span id="cb20-33"><a href="#cb20-33"></a><span class="st">  </span><span class="kw">xlab</span>(<span class="st">"pna"</span>) <span class="op">+</span></span>
<span id="cb20-34"><a href="#cb20-34"></a><span class="st">  </span><span class="kw">scale_fill_manual</span>(</span>
<span id="cb20-35"><a href="#cb20-35"></a>    <span class="dt">name =</span> <span class="st">"pna"</span>, </span>
<span id="cb20-36"><a href="#cb20-36"></a>    <span class="dt">values =</span> <span class="kw">c</span>(<span class="st">"steelblue1"</span>,<span class="st">"green3"</span>)</span>
<span id="cb20-37"><a href="#cb20-37"></a>    ) <span class="op">+</span></span>
<span id="cb20-38"><a href="#cb20-38"></a><span class="st">  </span><span class="kw">scale_alpha</span>(</span>
<span id="cb20-39"><a href="#cb20-39"></a>    <span class="dt">name =</span> <span class="st">"median topic distribution"</span></span>
<span id="cb20-40"><a href="#cb20-40"></a>    ) <span class="op">+</span></span>
<span id="cb20-41"><a href="#cb20-41"></a><span class="st">  </span><span class="kw">theme_minimal</span>(</span>
<span id="cb20-42"><a href="#cb20-42"></a>    <span class="dt">base_size =</span> <span class="dv">20</span></span>
<span id="cb20-43"><a href="#cb20-43"></a>    ) <span class="op">+</span><span class="st">  </span></span>
<span id="cb20-44"><a href="#cb20-44"></a><span class="st">  </span><span class="kw">theme</span>(</span>
<span id="cb20-45"><a href="#cb20-45"></a>    <span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb20-46"><a href="#cb20-46"></a>    <span class="dt">strip.text.x =</span> <span class="kw">element_text</span>(<span class="dt">angle =</span> <span class="dv">90</span>)</span>
<span id="cb20-47"><a href="#cb20-47"></a>    )</span>
<span id="cb20-48"><a href="#cb20-48"></a>p</span>
<span id="cb20-49"><a href="#cb20-49"></a><span class="kw">ggsave</span>(<span class="kw">paste0</span>(<span class="st">"topic_dis_all_"</span>,K, <span class="st">".png"</span>)), p, width =<span class="st"> </span><span class="dv">30</span>, height =<span class="st"> </span><span class="dv">16</span><span class="er">)</span></span></code></pre></div>
<p><img src="topic_dis_all_11.png" width="70%" style="display: block; margin: auto;"></p>
</div>
<div id="asv-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#asv-distribution" class="anchor"></a>ASV distribution</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># an array (iterations *topic * ASV)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">beta</span> 

<span class="co"># an array (iterations *topic * ASV)</span>
<span class="va">beta_aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/betaAligned.html">betaAligned</a></span><span class="op">(</span>
  <span class="va">beta</span>, 
  <span class="va">K</span>, 
  <span class="va">aligned</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chain <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span> 


<span class="co"># array to data frame</span>
<span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="va">beta_aligned</span> <span class="op">%&gt;%</span>
  <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span>
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iterations"</span>, 
                 <span class="st">"topic"</span>, 
                 <span class="st">"rsv_ix"</span><span class="op">)</span>,
    value.name <span class="op">=</span> <span class="st">"beta_h"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
  <span class="op">)</span><span class="op">[</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span><span class="op">]</span>

<span class="co"># join taxa_table with beta_hat</span>

<span class="co">## If we use a taxonomy level with NA, </span>
<span class="co">## we can replace the taxonomy level with </span>
<span class="co">## one level before this level</span>
<span class="co">#taxa$Class[which(is.na(taxa$Class))] = taxa$Phylum[which(is.na(taxa$Class))]</span>
<span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> 

<span class="va">taxa</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="va">beta_hat</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">taxa</span>, 
    by <span class="op">=</span> <span class="st">"rsv"</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Topic"</span>, <span class="va">topic</span><span class="op">)</span>
    <span class="op">)</span>

<span class="co"># Filtering ASVs for visualization:</span>
<span class="co">## We can filter by ASVs proportion in all topics.</span>

<span class="va">beta_hat</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">topic</span><span class="op">)</span>

<span class="co"># We plot the median of posterior sample and keep all taxonomy for each ASV.</span>
<span class="va">beta_summary</span> <span class="op">&lt;-</span> <span class="va">beta_hat</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>
    <span class="va">rsv_ix</span>, 
    <span class="va">topic</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    beta_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">beta_h</span><span class="op">)</span>,
    rsv <span class="op">=</span> <span class="va">rsv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Phylum <span class="op">=</span> <span class="va">Phylum</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Class <span class="op">=</span> <span class="va">Class</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Order <span class="op">=</span> <span class="va">Order</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Family <span class="op">=</span> <span class="va">Family</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Genus <span class="op">=</span> <span class="va">Genus</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="op">)</span>

<span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">beta_summary</span><span class="op">)</span>

<span class="co">#######</span>
<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_summary</span> 

<span class="va">beta_subset</span><span class="op">$</span><span class="va">rsv_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">)</span> <span class="op">/</span> <span class="va">K</span>
    <span class="op">)</span>, 
  each <span class="op">=</span> <span class="va">K</span>
  <span class="op">)</span>


<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span>
    <span class="va">rsv_ix</span>, 
    <span class="va">topic</span>
    <span class="op">)</span>

<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    Class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
      <span class="va">Class</span>, 
      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>
      <span class="op">)</span>,
    Topic <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">topic</span>, <span class="st">"Topic "</span><span class="op">)</span>
    <span class="op">)</span>


<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>, 
  <span class="st">"other"</span>, 
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>


<span class="va">beta_subset</span><span class="op">$</span><span class="va">Topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Topic</span>,
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co">####</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">beta_subset</span>, 
  <span class="va">rsv_ix</span>, 
  <span class="va">rsv</span>, 
  <span class="va">topic</span>, 
  <span class="va">Class</span>, 
  <span class="va">beta_median</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span>, 
  <span class="op">-</span><span class="va">rsv_ix</span>
  <span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span>, 
  key <span class="op">=</span> <span class="va">topic</span>, 
  value <span class="op">=</span> <span class="va">beta_median</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">rsv</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>, 
  <span class="st">"other"</span>, 
  <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="co"># Choose rsv if at least in one topic the feature distribution is greater than the cutoff = 0.008</span>
<span class="va">choose_rsv_logical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, 
  <span class="fl">1</span>, 
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.008</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">1</span>
    <span class="op">}</span>
  <span class="op">)</span>

<span class="va">choose_rsv</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">rsv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span>
  <span class="va">choose_rsv_logical</span>
  <span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

  
<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span><span class="va">choose_rsv</span>, <span class="op">]</span>

<span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/phy_tree-methods.html">phy_tree</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/prune_taxa-methods.html">prune_taxa</a></span><span class="op">(</span>
    <span class="va">choose_rsv</span>, 
    <span class="va">ps</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">circ</span> <span class="op">&lt;-</span> <span class="fu">ggtree</span><span class="op">(</span>
  <span class="va">tree</span>, 
  layout <span class="op">=</span> <span class="st">"circular"</span>
  <span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>, <span class="op">]</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rsv"</span>, <span class="st">"Class"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Topic "</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>

<span class="va">color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomcoloR/man/distinctColorPalette.html">distinctColorPalette</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span>
      <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">color_topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span>

<span class="co">## in circular plot, ASVs will be labeled by Class </span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  Class <span class="op">=</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>


<span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>


<span class="co">## append Class to phylogenetic tree</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">gheatmap</span><span class="op">(</span>
  p <span class="op">=</span> <span class="va">circ</span>, 
  data <span class="op">=</span> <span class="va">df</span>, 
  offset <span class="op">=</span> <span class="op">-</span><span class="fl">.1</span>, 
  width <span class="op">=</span> <span class="fl">.1</span>,
  colnames_angle <span class="op">=</span> <span class="fl">95</span>, 
  colnames_offset_y <span class="op">=</span> <span class="fl">.5</span>, 
  font.size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_manual</span><span class="op">(</span>
    values <span class="op">=</span> <span class="va">color</span>, 
    name <span class="op">=</span> <span class="st">"Class"</span>
    <span class="op">)</span>


<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> 
      <span class="fu">new_scale_fill</span><span class="op">(</span><span class="op">)</span><span class="co"># to make once fill scale</span>
  <span class="op">}</span>
  <span class="va">df2_i</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">beta_subset_wide</span>, <span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df2_i</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">gheatmap</span><span class="op">(</span>
    <span class="va">p</span>,
    <span class="va">df2_i</span>,
    offset <span class="op">=</span> <span class="va">i</span><span class="op">*</span><span class="fl">.08</span>, 
    width <span class="op">=</span> <span class="fl">.1</span>,
    colnames_angle <span class="op">=</span> <span class="fl">90</span>, 
    colnames_offset_y <span class="op">=</span> <span class="fl">.25</span>, 
    font.size <span class="op">=</span> <span class="fl">6</span>,
    high <span class="op">=</span> <span class="st">"dodgerblue"</span>,
    low <span class="op">=</span> <span class="st">"gray98"</span>,
    legend_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> 
<span class="op">}</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> 
  <span class="fu">theme_minimal</span><span class="op">(</span>
    base_size <span class="op">=</span> <span class="fl">20</span>
    <span class="op">)</span> <span class="op">+</span>  
  <span class="fu">theme</span><span class="op">(</span>
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
    <span class="op">)</span>

<span class="fu">ggsave</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"circular_plot_plant_all_K_"</span>, <span class="va">K</span>, <span class="st">".png"</span><span class="op">)</span>, <span class="va">p</span>, width <span class="op">=</span> <span class="fl">28</span>, height <span class="op">=</span> <span class="fl">22</span><span class="op">)</span></code></pre></div>
<p><img src="circular_plot_plant_all_K_11.png" width="70%" style="display: block; margin: auto;"></p>
</div>
<div id="diagnostic-and-model-assessement-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostic-and-model-assessement-plots" class="anchor"></a>Diagnostic and model assessement plots</h3>
</div>
</div>
<div id="differential-topic-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#differential-topic-analysis" class="anchor"></a>Differential topic analysis</h2>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Pratheepa Jeganathan.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
