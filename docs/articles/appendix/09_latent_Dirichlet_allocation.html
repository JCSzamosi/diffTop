<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Section 9: LATENT DIRICHLET ALLOCATION â€¢ diffTop</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Section 9: LATENT DIRICHLET ALLOCATION">
<meta property="og:description" content="diffTop">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">diffTop</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.99.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/diffTop.html">Get started</a>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/appendix/01_introduction.html">Section 1: INTRODUCTION</a>
    </li>
    <li>
      <a href="../../articles/appendix/02_microbiome_data.html">Section 2: MICROBIOME DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/03_example_16S_data.html">Section 3: EXAMPLE OF 16S rRNA GENE SEQUENCING DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/04_models.html">Section 4: MODELS</a>
    </li>
    <li>
      <a href="../../articles/appendix/05_transformation.html">Section 5: TRANSFORMATIONS</a>
    </li>
    <li>
      <a href="../../articles/appendix/06_visualization.html">Section 6: VISUALIZATIONS FOR HETEROGENEOUS DATA</a>
    </li>
    <li>
      <a href="../../articles/appendix/07_multivariate_and_network_analysis.html">Section 7: MULTIVARIATE AND NETWORK ANALYSES</a>
    </li>
    <li>
      <a href="../../articles/appendix/08_differential_abundance_analysis.html">Section 8: DIFFERENTIAL ABUNDANCE ANALYSIS</a>
    </li>
    <li>
      <a href="../../articles/appendix/09_latent_Dirichlet_allocation.html">Section 9: LATENT DIRICHLET ALLOCATION</a>
    </li>
    <li>
      <a href="../../articles/appendix/10_uncertainity_quan_ordination.html">Section 10: UNCERTAINTY QUANTIFICATION FOR ORDINATION ANALYSIS</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="09_latent_Dirichlet_allocation_files/header-attrs-2.9/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Section 9: LATENT DIRICHLET ALLOCATION</h1>
                        <h4 class="author">Pratheepa Jeganathan</h4>
            
            <h4 class="date">03 August, 2021</h4>
      
      
      <div class="hidden name"><code>09_latent_Dirichlet_allocation.Rmd</code></div>

    </div>

    
    
<p>In this data set, we are interested infer on the topics (bacterial communities) when we use original and modified PNA clams (two different experimental conditions). To infer about these topics, we use latent Dirichlet allocation.</p>
<div id="input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#input-data" class="anchor"></a>Input data</h2>
<p>We set-up data for latent Dirichlet allocation (LDA) based on a <code>phyloseq</code> object <code>(psE_BARBI)</code>, the number of topics (K=11), hyperparameters for topic proportion in each sample <span class="math inline">\(\alpha = 0.8\)</span> and ASVs proportion in each topic <span class="math inline">\(gamma = 0.8\)</span>.</p>
<p>In <code>psE_BARBI</code>, we removed DNA contaminants using BARBI. Then, we choose ASVs that have at least 25 counts in at least two specimens.</p>
<p>We set the hyper-parameters <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\gamma\)</span> less than one to generate mixtures that are different from each other. We choose 0.8 for <span class="math inline">\(\alpha\)</span> across all samples so that we avoid generating unrealistic topics.</p>
<p>We estimate the parameters using HMC NUTS with four chains and 2000 iterations. Out of these 2000 iterations, 1000 iterations were used as warm-up samples.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">K</span> <span class="op">&lt;-</span> <span class="fl">11</span>
<span class="va">iter</span> <span class="op">&lt;-</span> <span class="fl">2000</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://dx.plos.org/10.1371/journal.pone.0061217">phyloseq</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">genefilter</span><span class="op">)</span> <span class="co">#KOverA</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.rcpp.org">Rcpp</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan">rstan</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">randomcoloR</span><span class="op">)</span><span class="co"># distinctColorPalette(n)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mikelove/DESeq2">DESeq2</a></span><span class="op">)</span>

<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">theme_set</span><span class="op">(</span><span class="fu">theme_minimal</span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="fu">theme_update</span><span class="op">(</span>
  text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,
  legend.text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="data" class="section level2">
<h2 class="hasAnchor">
<a href="#data" class="anchor"></a>Data</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"psE_BARBI"</span><span class="op">)</span>
<span class="va">threshold</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/genefilter/man/kOverA.html">kOverA</a></span><span class="op">(</span><span class="fl">2</span>, A <span class="op">=</span> <span class="fl">25</span><span class="op">)</span> 
<span class="va">psE_BARBI</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/filter_taxa.html">filter_taxa</a></span><span class="op">(</span>
  <span class="va">psE_BARBI</span>, 
  <span class="va">threshold</span>, <span class="cn">TRUE</span><span class="op">)</span> 

<span class="va">psE_BARBI</span></code></pre></div>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 1418 taxa and 86 samples ]
## sample_data() Sample Data:       [ 86 samples by 16 sample variables ]
## tax_table()   Taxonomy Table:    [ 1418 taxa by 6 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 1418 tips and 1417 internal nodes ]</code></pre>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ps</span> <span class="op">&lt;-</span> <span class="va">psE_BARBI</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">psE_BARBI</span><span class="op">)</span>
<span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/prune_taxa-methods.html">prune_taxa</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/taxa_sums.html">taxa_sums</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="va">ps</span><span class="op">)</span>
<span class="va">ps</span></code></pre></div>
<pre><code>## phyloseq-class experiment-level object
## otu_table()   OTU Table:         [ 1418 taxa and 86 samples ]
## sample_data() Sample Data:       [ 86 samples by 16 sample variables ]
## tax_table()   Taxonomy Table:    [ 1418 taxa by 6 taxonomic ranks ]
## phy_tree()    Phylogenetic Tree: [ 1418 tips and 1417 internal nodes ]</code></pre>
<div id="edit-specimen-names" class="section level3">
<h3 class="hasAnchor">
<a href="#edit-specimen-names" class="anchor"></a>Edit specimen names</h3>
<p>We edit specimen names and identify Asteraceae and non-Asteraceae plants.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>, <span class="st">"E106"</span>, <span class="st">"E-106"</span><span class="op">)</span>
<span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">sam_names</span>, <span class="st">"_F_filt.fastq.gz"</span>, <span class="st">""</span><span class="op">)</span>
<span class="va">sam_names</span> <span class="op">&lt;-</span> <span class="fu">str_replace</span><span class="op">(</span><span class="va">sam_names</span>, <span class="st">"Connor-"</span>, <span class="st">"E"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">$</span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">$</span><span class="va">unique_names</span> <span class="op">&lt;-</span> <span class="va">sam_names</span>
<span class="va">aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"142"</span>,<span class="st">"143"</span>,<span class="st">"15"</span>,<span class="st">"ST"</span>,<span class="st">"22"</span>,<span class="st">"40"</span><span class="op">)</span>
<span class="va">non_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"33"</span>, <span class="st">"71"</span>, <span class="st">"106"</span><span class="op">)</span>

<span class="va">paired_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E-142-1"</span>, <span class="st">"E142-1"</span>, <span class="st">"E-142-5"</span>, <span class="st">"E142-5"</span>, <span class="st">"E-142-10"</span>, <span class="st">"E142-10"</span>, <span class="st">"E-143-2"</span>, <span class="st">"E143-2"</span>, <span class="st">"E-143-7"</span>, <span class="st">"E143-7"</span>, <span class="st">"E-15-1"</span>, <span class="st">"E15-1"</span>, <span class="st">"ST-CAZ-4-R-O"</span>, <span class="st">"ST-CAZ-4-R-M"</span>, <span class="st">"ST-SAL-22-R-O"</span>, <span class="st">"ST-SAL-22-R-M"</span>, <span class="st">"ST-TRI-10-R-O"</span>, <span class="st">"ST-TRI-10-R-M"</span><span class="op">)</span>
<span class="va">paired_non_aster</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"E33-7"</span>, <span class="st">"E-33-7"</span>, <span class="st">"E33-8"</span>, <span class="st">"E-33-8"</span>, <span class="st">"E33-9"</span>, <span class="st">"E-33-9"</span>, <span class="st">"E71-10"</span>, <span class="st">"E-71-10"</span>,<span class="st">"E71-2"</span>,<span class="st">"E-71-2"</span> ,<span class="st">"E71-3"</span>, <span class="st">"E-71-3"</span>, <span class="st">"E106-1"</span>, <span class="st">"E-106-1"</span>, <span class="st">"E106-3"</span>, <span class="st">"E-106-3"</span>, <span class="st">"E106-4"</span>, <span class="st">"E-106-4"</span><span class="op">)</span>
<span class="va">paired_specimens</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">paired_aster</span>, <span class="va">paired_non_aster</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># We will use 9 colors for 9 different plants</span>
<span class="va">plant_colors</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>, <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>, <span class="st">"purple"</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="topic-modeling" class="section level2">
<h2 class="hasAnchor">
<a href="#topic-modeling" class="anchor"></a>Topic modeling</h2>
<div id="set-up-data" class="section level3">
<h3 class="hasAnchor">
<a href="#set-up-data" class="anchor"></a>Set-up data</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/get_taxa-methods.html">get_taxa</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="co"># theta[d] ~ dirichlet(alpha), alpha pseudocount for each topic</span>
<span class="co"># beta[k] ~ dirichlet(gamma), gamma pseudocount for each ASV in each topic</span>
<span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] 11</code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">stan.data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>K <span class="op">=</span> <span class="va">K</span>, 
  V <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, 
  D <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, 
  n <span class="op">=</span> <span class="va">x</span>, 
  alpha <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.8</span>, <span class="va">K</span><span class="op">)</span>, 
  gamma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">.5</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
</div>
<div id="posterior-sampling" class="section level3">
<h3 class="hasAnchor">
<a href="#posterior-sampling" class="anchor"></a>Posterior sampling</h3>
<p><span class="math inline">\(\theta\)</span> and <span class="math inline">\(B = \left[\beta_{1}, \cdots, \beta_{K} \right]^{T}.\)</span></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fileN</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"JABES_Endo_all_K_"</span>,
  <span class="va">K</span>,
  <span class="st">"_ite_"</span>,
  <span class="va">iter</span>,
  <span class="st">".RData"</span>
  <span class="op">)</span>

<span class="va">stan.fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/stan.html">stan</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">"./lda.stan"</span>, 
  data <span class="op">=</span> <span class="va">stan.data</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chains <span class="op">=</span> <span class="fl">4</span>, 
  sample_file <span class="op">=</span> <span class="cn">NULL</span>,
  diagnostic_file <span class="op">=</span> <span class="cn">NULL</span>,
  cores <span class="op">=</span> <span class="fl">4</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span>,
  save_dso <span class="op">=</span> <span class="cn">TRUE</span>,
  algorithm <span class="op">=</span> <span class="st">"NUTS"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span><span class="op">(</span><span class="va">stan.fit</span>, file <span class="op">=</span> <span class="va">fileN</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">fileN</span><span class="op">)</span></code></pre></div>
</div>
<div id="extract-posterior-samples" class="section level3">
<h3 class="hasAnchor">
<a href="#extract-posterior-samples" class="anchor"></a>Extract posterior samples</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span>
  <span class="va">stan.fit</span>, 
  permuted <span class="op">=</span> <span class="cn">TRUE</span>, 
  inc_warmup <span class="op">=</span> <span class="cn">FALSE</span>, 
  include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="co"># samples is a list</span></code></pre></div>
</div>
<div id="alignment" class="section level3">
<h3 class="hasAnchor">
<a href="#alignment" class="anchor"></a>Alignment</h3>
<ul>
<li>Create a Topic <span class="math inline">\(*\)</span> Chain matrix</li>
</ul>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">theta</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">theta</span> 
<span class="co"># dim(theta)</span>
<span class="va">aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/alignmentMatrix.html">alignmentMatrix</a></span><span class="op">(</span>
  <span class="va">theta</span>, 
  <span class="va">ps</span>, 
  <span class="va">K</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>,
  chain <span class="op">=</span> <span class="fl">4</span>,
  SampleID_name <span class="op">=</span> <span class="st">"unique_names"</span>
  <span class="op">)</span>

<span class="va">theta_aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/thetaAligned.html">thetaAligned</a></span><span class="op">(</span>
  <span class="va">theta</span>, 
  <span class="va">K</span>, 
  <span class="va">aligned</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chain <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_names-methods.html">sample_names</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Topic_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># array to a dataframe</span>
<span class="va">theta_all</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
<span class="st">"iteration"</span>, 
<span class="st">"Sample"</span>, 
<span class="st">"Topic"</span>, 
<span class="st">"topic.dis"</span>
<span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"Chain "</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>, 
      each <span class="op">=</span> <span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>
      <span class="op">)</span>
  <span class="op">)</span>

<span class="va">sam</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">theta_all</span> <span class="op">&lt;-</span> <span class="fu">left_join</span><span class="op">(</span>
  <span class="va">theta_all</span>, 
  <span class="va">sam</span>, 
  by <span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Sample"</span><span class="op">=</span> <span class="st">"unique_names"</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Chain</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">Topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Topic</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">Sample</span><span class="op">)</span>
<span class="va">theta_all</span><span class="op">$</span><span class="va">pna</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">theta_all</span><span class="op">$</span><span class="va">pna</span><span class="op">)</span></code></pre></div>
</div>
<div id="plot-the-topic-distribution-in-all-chains" class="section level3">
<h3 class="hasAnchor">
<a href="#plot-the-topic-distribution-in-all-chains" class="anchor"></a>Plot the topic distribution in all chains</h3>
<ul>
<li>facet by pna and aster or non-aster plant type.</li>
</ul>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>theta_summary <span class="ot">&lt;-</span> theta_all <span class="sc">%&gt;%</span> </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    Sample, </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    Topic, </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>    pna</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">median.topic.dis =</span> <span class="fu">median</span>(topic.dis)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span> </span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">Topic =</span> <span class="fu">factor</span>(</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>      Topic, </span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">levels =</span> <span class="fu">rev</span>(<span class="fu">str_c</span>(<span class="st">"Topic_"</span>,<span class="dv">1</span><span class="sc">:</span>K)</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>                   )</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>  theta_summary, </span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">aes</span>(<span class="at">x =</span> pna, </span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">y =</span> Topic,</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">fill =</span> pna)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> p<span class="sc">+</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>(</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">alpha =</span> median.topic.dis)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_grid</span>(</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    .<span class="sc">~</span>Sample,</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">scale =</span> <span class="st">"free"</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    )<span class="sc">+</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">xlab</span>(<span class="st">"pna"</span>) <span class="sc">+</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"pna"</span>, </span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">values =</span> <span class="fu">c</span>(<span class="st">"steelblue1"</span>,<span class="st">"green3"</span>)</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_alpha</span>(</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">"median topic distribution"</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">base_size =</span> <span class="dv">20</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span>  </span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.title =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> <span class="fl">0.5</span>),</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">90</span>)</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>p</span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="fu">paste0</span>(<span class="st">"topic_dis_all_"</span>,K, <span class="st">".png"</span>)), p, width <span class="ot">=</span> <span class="dv">30</span>, height <span class="ot">=</span> <span class="dv">16</span><span class="er">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="topic_dis_all_11.png" alt="Figure 6: Topic distribution in specimens from Sonchus Arvensis plant. The color gradient represents the median topic distribution." width="70%"><p class="caption">
Figure 6: Topic distribution in specimens from Sonchus Arvensis plant. The color gradient represents the median topic distribution.
</p>
</div>
</div>
<div id="asv-distribution" class="section level3">
<h3 class="hasAnchor">
<a href="#asv-distribution" class="anchor"></a>ASV distribution</h3>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># an array (iterations *topic * ASV)</span>
<span class="va">beta</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">beta</span> 

<span class="co"># an array (iterations *topic * ASV)</span>
<span class="va">beta_aligned</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/betaAligned.html">betaAligned</a></span><span class="op">(</span>
  <span class="va">beta</span>, 
  <span class="va">K</span>, 
  <span class="va">aligned</span>, 
  iter <span class="op">=</span> <span class="va">iter</span>, 
  chain <span class="op">=</span> <span class="fl">4</span>
  <span class="op">)</span> 


<span class="co"># array to data frame</span>
<span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="va">beta_aligned</span> <span class="op">%&gt;%</span>
  <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html">melt</a></span><span class="op">(</span>
    varnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"iterations"</span>, 
                 <span class="st">"topic"</span>, 
                 <span class="st">"rsv_ix"</span><span class="op">)</span>,
    value.name <span class="op">=</span> <span class="st">"beta_h"</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
  <span class="op">)</span><span class="op">[</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span><span class="op">]</span>

<span class="co"># join taxa_table with beta_hat</span>

<span class="co">## If we use a taxonomy level with NA, </span>
<span class="co">## we can replace the taxonomy level with </span>
<span class="co">## one level before this level</span>
<span class="co">#taxa$Class[which(is.na(taxa$Class))] = taxa$Phylum[which(is.na(taxa$Class))]</span>
<span class="va">taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span>  
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">as_tibble</span><span class="op">(</span><span class="op">)</span> 

<span class="va">taxa</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">beta_hat</span> <span class="op">&lt;-</span> <span class="va">beta_hat</span> <span class="op">%&gt;%</span>
  <span class="fu">left_join</span><span class="op">(</span>
    <span class="va">taxa</span>, 
    by <span class="op">=</span> <span class="st">"rsv"</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">mutate</span><span class="op">(</span>
    topic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Topic"</span>, <span class="va">topic</span><span class="op">)</span>
    <span class="op">)</span>

<span class="co"># Filtering ASVs for visualization:</span>
<span class="co">## We can filter by ASVs proportion in all topics.</span>

<span class="va">beta_hat</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">rsv_ix</span><span class="op">)</span>
<span class="va">beta_hat</span><span class="op">$</span><span class="va">topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">beta_hat</span><span class="op">$</span><span class="va">topic</span><span class="op">)</span>

<span class="co"># We plot the median of posterior sample and keep all taxonomy for each ASV.</span>
<span class="va">beta_summary</span> <span class="op">&lt;-</span> <span class="va">beta_hat</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>
    <span class="va">rsv_ix</span>, 
    <span class="va">topic</span>
    <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>
    beta_median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html">median</a></span><span class="op">(</span><span class="va">beta_h</span><span class="op">)</span>,
    rsv <span class="op">=</span> <span class="va">rsv</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Phylum <span class="op">=</span> <span class="va">Phylum</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Class <span class="op">=</span> <span class="va">Class</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Order <span class="op">=</span> <span class="va">Order</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Family <span class="op">=</span> <span class="va">Family</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>,
    Genus <span class="op">=</span> <span class="va">Genus</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
  <span class="op">)</span>

<span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">beta_summary</span><span class="op">)</span>

<span class="co">#######</span>
<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_summary</span> 

<span class="va">beta_subset</span><span class="op">$</span><span class="va">rsv_ix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_len</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">)</span> <span class="op">/</span> <span class="va">K</span>
    <span class="op">)</span>, 
  each <span class="op">=</span> <span class="va">K</span>
  <span class="op">)</span>


<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span> <span class="op">%&gt;%</span> 
  <span class="fu">arrange</span><span class="op">(</span>
    <span class="va">rsv_ix</span>, 
    <span class="va">topic</span>
    <span class="op">)</span>

<span class="va">beta_subset</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span> <span class="op">%&gt;%</span>
  <span class="fu">mutate</span><span class="op">(</span>
    Class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
      <span class="va">Class</span>, 
      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>
      <span class="op">)</span>,
    Topic <span class="op">=</span> <span class="fu">str_remove</span><span class="op">(</span><span class="va">topic</span>, <span class="st">"Topic "</span><span class="op">)</span>
    <span class="op">)</span>


<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>, 
  <span class="st">"other"</span>, 
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>


<span class="va">beta_subset</span><span class="op">$</span><span class="va">Topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset</span><span class="op">$</span><span class="va">Topic</span>,
  levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

<span class="co">####</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">beta_subset</span>, 
  <span class="va">rsv_ix</span>, 
  <span class="va">rsv</span>, 
  <span class="va">topic</span>, 
  <span class="va">Class</span>, 
  <span class="va">beta_median</span>
  <span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span>, 
  <span class="op">-</span><span class="va">rsv_ix</span>
  <span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/spread.html">spread</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span>, 
  key <span class="op">=</span> <span class="va">topic</span>, 
  value <span class="op">=</span> <span class="va">beta_median</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">rsv</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>, 
  <span class="st">"other"</span>, 
  <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span><span class="op">)</span>

<span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="co"># Choose rsv if at least in one topic the feature distribution is greater than the cutoff = 0.008</span>
<span class="va">choose_rsv_logical</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
  <span class="va">beta_subset_wide</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>, 
  <span class="fl">1</span>, 
  <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">x</span> <span class="op">&gt;=</span> <span class="fl">0.008</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="fl">1</span>
    <span class="op">}</span>
  <span class="op">)</span>

<span class="va">choose_rsv</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">rsv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span>
  <span class="va">choose_rsv_logical</span>
  <span class="op">)</span><span class="op">]</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="op">)</span>

  
<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span><span class="va">choose_rsv</span>, <span class="op">]</span>

<span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu">phyloseq</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/phy_tree-methods.html">phy_tree</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/prune_taxa-methods.html">prune_taxa</a></span><span class="op">(</span>
    <span class="va">choose_rsv</span>, 
    <span class="va">ps</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">circ</span> <span class="op">&lt;-</span> <span class="fu">ggtree</span><span class="op">(</span>
  <span class="va">tree</span>, 
  layout <span class="op">=</span> <span class="st">"circular"</span>
  <span class="op">)</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span><span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>, <span class="op">]</span>

<span class="va">beta_subset_wide</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span> , <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"rsv"</span>, <span class="st">"Class"</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Topic "</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">K</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>

<span class="va">color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/randomcoloR/man/distinctColorPalette.html">distinctColorPalette</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span>
    <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span>
      <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
      <span class="op">)</span>
    <span class="op">)</span>
  <span class="op">)</span>

<span class="va">color_topic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html">rainbow</a></span><span class="op">(</span><span class="va">K</span><span class="op">)</span>

<span class="co">## in circular plot, ASVs will be labeled by Class </span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  Class <span class="op">=</span> <span class="va">beta_subset_wide</span><span class="op">$</span><span class="va">Class</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>


<span class="va">df2</span> <span class="op">&lt;-</span> <span class="va">beta_subset_wide</span><span class="op">[</span>, <span class="fl">3</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_subset_wide</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>


<span class="co">## append Class to phylogenetic tree</span>
<span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">gheatmap</span><span class="op">(</span>
  p <span class="op">=</span> <span class="va">circ</span>, 
  data <span class="op">=</span> <span class="va">df</span>, 
  offset <span class="op">=</span> <span class="op">-</span><span class="fl">.1</span>, 
  width <span class="op">=</span> <span class="fl">.1</span>,
  colnames_angle <span class="op">=</span> <span class="fl">95</span>, 
  colnames_offset_y <span class="op">=</span> <span class="fl">.5</span>, 
  font.size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">scale_fill_manual</span><span class="op">(</span>
    values <span class="op">=</span> <span class="va">color</span>, 
    name <span class="op">=</span> <span class="st">"Class"</span>
    <span class="op">)</span>


<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">K</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">if</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">{</span>
    <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> 
      <span class="fu">new_scale_fill</span><span class="op">(</span><span class="op">)</span><span class="co"># to make once fill scale</span>
  <span class="op">}</span>
  <span class="va">df2_i</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>
    <span class="va">beta_subset_wide</span>, <span class="op">(</span><span class="va">i</span><span class="op">+</span><span class="fl">2</span><span class="op">)</span>
    <span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">df2_i</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">tree</span><span class="op">$</span><span class="va">tip.label</span>
  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu">gheatmap</span><span class="op">(</span>
    <span class="va">p</span>,
    <span class="va">df2_i</span>,
    offset <span class="op">=</span> <span class="va">i</span><span class="op">*</span><span class="fl">.08</span>, 
    width <span class="op">=</span> <span class="fl">.1</span>,
    colnames_angle <span class="op">=</span> <span class="fl">90</span>, 
    colnames_offset_y <span class="op">=</span> <span class="fl">.25</span>, 
    font.size <span class="op">=</span> <span class="fl">6</span>,
    high <span class="op">=</span> <span class="st">"dodgerblue"</span>,
    low <span class="op">=</span> <span class="st">"gray98"</span>,
    legend_title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html">expression</a></span><span class="op">(</span><span class="va">beta</span><span class="op">[</span><span class="va">k</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> 
<span class="op">}</span>

<span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> 
  <span class="fu">theme_minimal</span><span class="op">(</span>
    base_size <span class="op">=</span> <span class="fl">20</span>
    <span class="op">)</span> <span class="op">+</span>  
  <span class="fu">theme</span><span class="op">(</span>
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
    <span class="op">)</span>

<span class="fu">ggsave</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"circular_plot_plant_all_K_"</span>, <span class="va">K</span>, <span class="st">".png"</span><span class="op">)</span>, <span class="va">p</span>, width <span class="op">=</span> <span class="fl">28</span>, height <span class="op">=</span> <span class="fl">22</span><span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="circular_plot_plant_all_K_11.png" alt="Figure 7: ASV distribution over topics in all specimens" width="100%"><p class="caption">
Figure 7: ASV distribution over topics in all specimens
</p>
</div>
</div>
<div id="diagnostic-and-model-assessment-plots" class="section level3">
<h3 class="hasAnchor">
<a href="#diagnostic-and-model-assessment-plots" class="anchor"></a>Diagnostic and model assessment plots</h3>
<p>Model assessment</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu">rstan</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html">extract</a></span><span class="op">(</span>
  <span class="va">stan.fit</span>,
  permuted <span class="op">=</span> <span class="cn">TRUE</span>,
  inc_warmup <span class="op">=</span> <span class="cn">FALSE</span>,
  include <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="co"># samples is a list</span>

<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/get_taxa-methods.html">get_taxa</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
<span class="va">x_max_asv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
  <span class="va">x</span> <span class="op">%&gt;%</span> <span class="va">data.frame</span> , 
  <span class="fl">2</span>, 
  <span class="va">max</span><span class="op">)</span>

<span class="va">x_max_asv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  x_max_asv <span class="op">=</span> <span class="va">x_max_asv</span>
  <span class="op">)</span>

<span class="co"># draws from posterior predictive distribution</span>
<span class="va">x_sim</span> <span class="op">&lt;-</span> <span class="va">samples</span><span class="op">$</span><span class="va">x_sim</span> <span class="co"># iteration * samples * ASVs</span>
<span class="co"># Choose only the first chain</span>
<span class="va">x_sim</span> <span class="op">&lt;-</span> <span class="va">x_sim</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, ,<span class="op">]</span> <span class="co"># For each iteration, simulated data is x_sim[i, ,]</span>
<span class="va">sim_ite</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x_sim</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>

<span class="co">#Find maximum of each asv for each replication</span>
<span class="va">max_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">x_sim_i</span> <span class="op">&lt;-</span> <span class="va">x_sim</span><span class="op">[</span><span class="fl">1</span>, ,<span class="op">]</span>
<span class="va">max_x_sim_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
  <span class="va">x_sim_i</span> <span class="op">%&gt;%</span> <span class="va">data.frame</span> , 
  <span class="fl">2</span>, 
  <span class="va">max</span>
  <span class="op">)</span>
<span class="va">max_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">max_x_sim_i</span><span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">sim_ite</span><span class="op">)</span><span class="op">{</span>
  <span class="va">x_sim_i</span> <span class="op">&lt;-</span> <span class="va">x_sim</span><span class="op">[</span><span class="va">i</span>, ,<span class="op">]</span>
  <span class="va">max_x_sim_i</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
    <span class="va">x_sim_i</span> <span class="op">%&gt;%</span> <span class="va">data.frame</span> , 
    <span class="fl">2</span>, 
    <span class="va">max</span><span class="op">)</span>
  <span class="va">max_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">max_all</span>, <span class="va">max_x_sim_i</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">max_all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"x_max_rep"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">sim_ite</span><span class="op">)</span>
         <span class="op">)</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">max_all</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
  <span class="st">"ASV_"</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/ntaxa-methods.html">ntaxa</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">)</span>,
  <span class="st">"_"</span>, 
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">[</span>,<span class="st">"Class"</span><span class="op">]</span>
  <span class="op">)</span>

<span class="va">max_all</span> <span class="op">&lt;-</span> <span class="va">max_all</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## choose some of asvs for Posterior predictive check (these indexes are considered to avoid if ASV's Class is missing)</span>
<span class="va">max_all</span> <span class="op">&lt;-</span> <span class="va">max_all</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">10</span><span class="op">:</span><span class="fl">14</span>, <span class="fl">19</span><span class="op">:</span><span class="fl">26</span>, <span class="fl">36</span>, <span class="fl">51</span><span class="op">:</span><span class="fl">53</span>, <span class="fl">148</span><span class="op">)</span><span class="op">]</span>
<span class="va">max_all_long</span> <span class="op">&lt;-</span> <span class="fu">melt</span><span class="op">(</span><span class="va">max_all</span><span class="op">)</span>

<span class="co"># observed stat data frame</span>
<span class="va">x_max_asv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
  Var1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span>
    <span class="st">"x_max_obs"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x_max_asv</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
    <span class="op">)</span>, 
  Var2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"ASV_"</span>, 
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/ntaxa-methods.html">ntaxa</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">)</span>,
    <span class="st">"_"</span>, 
    <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/tax_table-methods.html">tax_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span><span class="op">[</span>,<span class="st">"Class"</span><span class="op">]</span>
    <span class="op">)</span>, 
  value <span class="op">=</span> <span class="va">x_max_asv</span><span class="op">$</span><span class="va">x_max_asv</span>
  <span class="op">)</span>

<span class="va">x_max_asv</span> <span class="op">&lt;-</span> <span class="va">x_max_asv</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span>,<span class="fl">10</span><span class="op">:</span><span class="fl">14</span>,<span class="fl">19</span><span class="op">:</span><span class="fl">26</span>,<span class="fl">36</span>,<span class="fl">51</span><span class="op">:</span><span class="fl">53</span>, <span class="fl">148</span><span class="op">)</span>,<span class="op">]</span>


<span class="va">p_hist</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">max_all_long</span>
  <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>
      x <span class="op">=</span> <span class="va">value</span>, 
      group <span class="op">=</span> <span class="va">Var2</span>
      <span class="op">)</span>,
    color <span class="op">=</span> <span class="st">"blue"</span>, 
    fill <span class="op">=</span> <span class="st">"blue"</span>,
    bins <span class="op">=</span> <span class="fl">50</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu">xlab</span><span class="op">(</span><span class="st">"maximum"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu">facet_wrap</span><span class="op">(</span><span class="op">~</span><span class="va">Var2</span>, nrow <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_vline</span><span class="op">(</span>
    data <span class="op">=</span> <span class="va">x_max_asv</span>, 
    <span class="fu">aes</span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, 
    color <span class="op">=</span> <span class="st">"purple"</span>
    <span class="op">)</span> <span class="op">+</span> 
  <span class="fu">theme_update</span><span class="op">(</span>
    text <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">8</span><span class="op">)</span>
    <span class="op">)</span>


<span class="fu">ggsave</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span>
    <span class="st">"model_assesment_hist_all_obs_sim_K_"</span>, 
    <span class="va">K</span>, 
    <span class="st">".png"</span>
    <span class="op">)</span>, 
  <span class="va">p_hist</span>, 
  width <span class="op">=</span> <span class="fl">12</span>, 
  height <span class="op">=</span> <span class="fl">6</span>
  <span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="model_assesment_hist_all_obs_sim_K_11.png" alt="Supplementary Figure 13: Predictive model check with simulated data, observed data, and a statistic G(Kij) = max{Kij}. Each facet shows the histogram of G(Kij) of each ASV in specimens from the posterior predictive distribution and the vertical line shows the value of G (Kij ) of each ASV in observed data." width="100%"><p class="caption">
Supplementary Figure 13: Predictive model check with simulated data, observed data, and a statistic G(Kij) = max{Kij}. Each facet shows the histogram of G(Kij) of each ASV in specimens from the posterior predictive distribution and the vertical line shows the value of G (Kij ) of each ASV in observed data.
</p>
</div>
<p>Compute <span class="math inline">\(\hat{R}\)</span> and ESS (effective sample size)</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">Rhat_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>

<span class="va">ESS_bulk_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>

<span class="va">ESS_tail_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>

<span class="kw">for</span><span class="op">(</span><span class="va">sam</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
  <span class="kw">for</span><span class="op">(</span><span class="va">top</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">theta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
    <span class="va">sims_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
      <span class="va">theta_aligned</span><span class="op">[</span> ,<span class="va">sam</span> , <span class="va">top</span><span class="op">]</span>, 
      nrow <span class="op">=</span> <span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, 
      ncol <span class="op">=</span> <span class="fl">4</span>, 
      byrow <span class="op">=</span> <span class="cn">FALSE</span>
      <span class="op">)</span>
    <span class="va">Rhat_theta</span><span class="op">[</span><span class="va">sam</span>, <span class="va">top</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">Rhat</a></span><span class="op">(</span><span class="va">sims_theta</span><span class="op">)</span>
    <span class="va">ESS_bulk_theta</span><span class="op">[</span><span class="va">sam</span>, <span class="va">top</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">ess_bulk</a></span><span class="op">(</span><span class="va">sims_theta</span><span class="op">)</span>
    <span class="va">ESS_tail_theta</span><span class="op">[</span><span class="va">sam</span>, <span class="va">top</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">ess_tail</a></span><span class="op">(</span><span class="va">sims_theta</span><span class="op">)</span>
  <span class="op">}</span>
  
<span class="op">}</span>

<span class="va">Rhat_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">Rhat_theta</span><span class="op">)</span>
<span class="va">ESS_bulk_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">ESS_bulk_theta</span><span class="op">)</span>
<span class="va">ESS_tail_theta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">ESS_tail_theta</span><span class="op">)</span>

<span class="va">Rhat_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>
<span class="va">ESS_bulk_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>
<span class="va">ESS_tail_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
  nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, 
  ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>
  <span class="op">)</span>
  
<span class="kw">for</span><span class="op">(</span><span class="va">top</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
    <span class="kw">for</span><span class="op">(</span><span class="va">fea</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">beta_aligned</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">{</span>
      <span class="va">sims_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span>
        <span class="va">beta_aligned</span><span class="op">[</span> , <span class="va">top</span>, <span class="va">fea</span><span class="op">]</span>, 
        nrow <span class="op">=</span> <span class="op">(</span><span class="va">iter</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, 
        ncol <span class="op">=</span> <span class="fl">4</span>, 
        byrow <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
      <span class="va">Rhat_beta</span><span class="op">[</span><span class="va">top</span>, <span class="va">fea</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">Rhat</a></span><span class="op">(</span><span class="va">sims_beta</span><span class="op">)</span>
      <span class="va">ESS_bulk_beta</span><span class="op">[</span><span class="va">top</span>, <span class="va">fea</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">ess_bulk</a></span><span class="op">(</span><span class="va">sims_beta</span><span class="op">)</span>
      <span class="va">ESS_tail_beta</span><span class="op">[</span><span class="va">top</span>, <span class="va">fea</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://mc-stan.org/rstan/reference/Rhat.html">ess_tail</a></span><span class="op">(</span><span class="va">sims_beta</span><span class="op">)</span>
    <span class="op">}</span>
  
<span class="op">}</span>

<span class="va">Rhat_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">Rhat_beta</span><span class="op">)</span>
<span class="va">ESS_bulk_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">ESS_bulk_beta</span><span class="op">)</span>
<span class="va">ESS_tail_beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">ESS_tail_beta</span><span class="op">)</span>

<span class="va">Rhat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">Rhat_theta</span>, <span class="va">Rhat_beta</span><span class="op">)</span>


<span class="va">ESS_bulk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ESS_bulk_theta</span>, <span class="va">ESS_bulk_beta</span><span class="op">)</span>


<span class="va">ESS_tail</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ESS_tail_theta</span>, <span class="va">ESS_tail_beta</span><span class="op">)</span>

<span class="co"># R hat ~ 1.05</span>
<span class="va">p_rhat</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>Rhat <span class="op">=</span> <span class="va">Rhat</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">Rhat</span><span class="op">)</span>, 
    fill <span class="op">=</span> <span class="st">"lavender"</span>, 
    colour <span class="op">=</span> <span class="st">"black"</span>, 
    bins <span class="op">=</span> <span class="fl">100</span>
    <span class="op">)</span> <span class="op">+</span>  
  <span class="fu">theme</span><span class="op">(</span>
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
    <span class="op">)</span>  <span class="op">+</span>
  <span class="fu">theme_minimal</span><span class="op">(</span>base_size <span class="op">=</span> <span class="fl">20</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span>


<span class="fu">ggsave</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"Rhat_plant_all_K_"</span>, <span class="va">K</span>, <span class="st">".png"</span><span class="op">)</span>, 
  <span class="va">p_rhat</span>, 
  width <span class="op">=</span> <span class="fl">9</span>, 
  height <span class="op">=</span> <span class="fl">6</span>
  <span class="op">)</span>

<span class="co"># ESS bulk and ESS tail at least 100 per Markov Chain in order to be reliable and indicate that estimates of respective posterior quantiles are reliable</span>

<span class="va">p_ess_bulk</span> <span class="op">&lt;-</span> <span class="fu">ggplot</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>ESS_bulk <span class="op">=</span> <span class="va">ESS_bulk</span><span class="op">)</span>
  <span class="op">)</span> <span class="op">+</span>
  <span class="fu">geom_histogram</span><span class="op">(</span>
    <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">ESS_bulk</span><span class="op">)</span>, 
    fill <span class="op">=</span> <span class="st">"lavender"</span>, 
    colour <span class="op">=</span> <span class="st">"black"</span>, 
    bins <span class="op">=</span> <span class="fl">100</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">theme</span><span class="op">(</span>
    plot.title <span class="op">=</span> <span class="fu">element_text</span><span class="op">(</span>hjust <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span>
    <span class="op">)</span>   <span class="op">+</span> 
  <span class="fu">theme_minimal</span><span class="op">(</span>
    base_size <span class="op">=</span> <span class="fl">20</span>
    <span class="op">)</span> <span class="op">+</span>
  <span class="fu">xlab</span><span class="op">(</span><span class="st">""</span><span class="op">)</span>


<span class="fu">ggsave</span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"ess_bulk_plant_all_K_"</span>, <span class="va">K</span>, <span class="st">".png"</span><span class="op">)</span>, 
  <span class="va">p_ess_bulk</span>, 
  width <span class="op">=</span> <span class="fl">9</span>, 
  height <span class="op">=</span> <span class="fl">6</span>
  <span class="op">)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="ess_bulk_plant_all_K_11.png" alt="Supplementary Figure 14: Effective sample size (ESS) with eleven topics." width="100%"><p class="caption">
Supplementary Figure 14: Effective sample size (ESS) with eleven topics.
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Rhat_plant_all_K_11.png" alt="Supplementary Figure 15: Split Rhat with eleven topics." width="100%"><p class="caption">
Supplementary Figure 15: Split Rhat with eleven topics.
</p>
</div>
</div>
</div>
<div id="differential-topic-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#differential-topic-analysis" class="anchor"></a>Differential topic analysis</h2>
<p>We do differential topic analysis to test whether topic memberships differ across conditions.</p>
<ol style="list-style-type: decimal">
<li><p>Compute the median Bayesian posterior of topic proportions in each specimen.</p></li>
<li><p>Multiply the proportions by the library size and round to an integer. This will give an abundance of the topic in each specimen.</p></li>
<li><p>Apply DESeq2 to identify differentially abundant topics across O and M pPNA types.</p></li>
</ol>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># posterior samples</span>
<span class="va">theta_aligned_abun</span> <span class="op">&lt;-</span> <span class="va">theta_aligned</span>
<span class="co"># median Bayesian posterior of topic proportions in each specimen</span>
<span class="va">median_theta_aligned_abun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span>
  <span class="va">theta_aligned_abun</span>, 
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, 
  <span class="va">median</span><span class="op">)</span>

<span class="co"># Multiply the proportions by the library size and round to an integer</span>
<span class="va">lib_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colSums</a></span><span class="op">(</span>
  <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/otu_table-methods.html">otu_table</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span>
  <span class="op">)</span>

<span class="va">median_theta_aligned_abun</span> <span class="op">&lt;-</span> <span class="va">median_theta_aligned_abun</span> <span class="op">*</span> <span class="va">lib_size</span>

<span class="va">median_theta_aligned_abun</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span>
  <span class="va">median_theta_aligned_abun</span>
  <span class="op">)</span>

<span class="va">sam_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/sample_data-methods.html">sample_data</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<div id="test-on-all-specimens" class="section level3">
<h3 class="hasAnchor">
<a href="#test-on-all-specimens" class="anchor"></a>Test on all specimens</h3>
<p>We do test on all specimens. We can write DESeq2 results to LaTex</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeqDataSet.html">DESeqDataSetFromMatrix</a></span><span class="op">(</span>
  countData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="va">median_theta_aligned_abun</span><span class="op">)</span>,
  colData <span class="op">=</span> <span class="va">sam_data</span>,
  design<span class="op">=</span> <span class="op">~</span> <span class="va">pna</span>
  <span class="op">)</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeq.html">DESeq</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  fitType <span class="op">=</span> <span class="st">"mean"</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">dds</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dds_all_K_"</span>, <span class="va">K</span>,<span class="st">".rds"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"dds_all_K_11"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span><span class="op">(</span><span class="va">dds_all_K_11</span><span class="op">)</span>
<span class="va">res</span> </code></pre></div>
<pre><code>## log2 fold change (MLE): pna O vs M 
## Wald test p-value: pna O vs M 
## DataFrame with 11 rows and 6 columns
##            baseMean log2FoldChange     lfcSE      stat      pvalue        padj
##           &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
## Topic_1  12980.2689      -0.902957  0.954118 -0.946379 3.43955e-01 0.609485512
## Topic_2   1388.4912       0.328641  0.691155  0.475495 6.34434e-01 0.719579869
## Topic_3     14.5487      -0.559488  0.584374 -0.957414 3.38358e-01 0.609485512
## Topic_4   6138.5557       2.056851  0.749974  2.742564 6.09615e-03 0.022352555
## Topic_5     50.1848       2.693638  0.665150  4.049672 5.12894e-05 0.000564184
## Topic_6   5002.9019      -0.285674  0.795705 -0.359020 7.19580e-01 0.719579869
## Topic_7     25.1418      -0.382548  0.498956 -0.766696 4.43262e-01 0.609485512
## Topic_8    642.9452       0.638403  0.749673  0.851575 3.94450e-01 0.609485512
## Topic_9    728.3070       0.780513  0.781941  0.998174 3.18195e-01 0.609485512
## Topic_10  2452.9197       2.617431  0.725300  3.608757 3.07668e-04 0.001692175
## Topic_11  6788.9347       0.330308  0.782177  0.422294 6.72811e-01 0.719579869</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#writeResTable(res, fileN = paste0("dds_all_K_", K,".tex"))</span></code></pre></div>
</div>
<div id="test-on-paired-specimens" class="section level3">
<h3 class="hasAnchor">
<a href="#test-on-paired-specimens" class="anchor"></a>Test on paired-specimens</h3>
<p>We do the test on paired-specimens.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeqDataSet.html">DESeqDataSetFromMatrix</a></span><span class="op">(</span>
  countData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="va">median_theta_aligned_abun</span><span class="op">)</span>,
  colData <span class="op">=</span> <span class="va">sam_data</span>,
  design<span class="op">=</span> <span class="op">~</span>  <span class="va">pna</span>
  <span class="op">)</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="va">dds</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">dds</span><span class="op">$</span><span class="va">X</span><span class="op">)</span> <span class="op">%in%</span> <span class="va">paired_specimens</span><span class="op">]</span>
<span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeq.html">DESeq</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  fitType <span class="op">=</span> <span class="st">"mean"</span>
  <span class="op">)</span>
 
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dds_all_paired_K_"</span>, <span class="va">K</span>,<span class="st">".rds"</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"dds_all_paired_K_11"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span><span class="op">(</span><span class="va">dds_all_paired_K_11</span><span class="op">)</span>
<span class="va">res</span> </code></pre></div>
<pre><code>## log2 fold change (MLE): pna O vs M 
## Wald test p-value: pna O vs M 
## DataFrame with 11 rows and 6 columns
##           baseMean log2FoldChange     lfcSE      stat      pvalue        padj
##          &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
## Topic_1  3983.7697      -9.412600  1.056278 -8.911103 5.05275e-19 5.55802e-18
## Topic_2   898.6700       1.491941  0.999725  1.492352 1.35607e-01 2.13097e-01
## Topic_3    23.5763       0.282751  0.924598  0.305810 7.59749e-01 8.12226e-01
## Topic_4  1138.7952       3.371133  0.995722  3.385618 7.10182e-04 1.95300e-03
## Topic_5    31.7514       2.290040  0.892339  2.566333 1.02780e-02 1.88430e-02
## Topic_6    83.5973       0.351490  0.912658  0.385128 7.00143e-01 8.12226e-01
## Topic_7    35.3625       0.233201  0.801434  0.290979 7.71067e-01 8.12226e-01
## Topic_8   393.8606      -0.265216  1.116438 -0.237556 8.12226e-01 8.12226e-01
## Topic_9   468.2304      -6.004885  0.944671 -6.356589 2.06282e-10 7.56369e-10
## Topic_10 1938.0794       3.029427  1.085621  2.790502 5.26263e-03 1.15778e-02
## Topic_11  419.7516       6.324962  0.940052  6.728314 1.71641e-11 9.44024e-11</code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#writeResTable(res, fileN = paste0("dds_all_paired_K_", K,".tex"))</span></code></pre></div>
</div>
<div id="test-on-paired-non-aster-specimens" class="section level3">
<h3 class="hasAnchor">
<a href="#test-on-paired-non-aster-specimens" class="anchor"></a>Test on paired non-Aster specimens</h3>
<p>We do the test on paired non-Aster specimens.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeqDataSet.html">DESeqDataSetFromMatrix</a></span><span class="op">(</span>
  countData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="va">median_theta_aligned_abun</span><span class="op">)</span>,
  colData <span class="op">=</span> <span class="va">sam_data</span>,
  design<span class="op">=</span> <span class="op">~</span>  <span class="va">pna</span>
  <span class="op">)</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="va">dds</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">dds</span><span class="op">$</span><span class="va">X</span><span class="op">)</span> <span class="op">%in%</span> <span class="va">paired_non_aster</span><span class="op">]</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeq.html">DESeq</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  fitType <span class="op">=</span> <span class="st">"mean"</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">dds</span>, 
        file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dds_all_paired_nonaster_K_"</span>, <span class="va">K</span>,<span class="st">".rds"</span><span class="op">)</span>
        <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"dds_all_paired_nonaster_K_11"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span><span class="op">(</span><span class="va">dds_all_paired_nonaster_K_11</span><span class="op">)</span>
<span class="va">res</span> </code></pre></div>
<pre><code>## log2 fold change (MLE): pna O vs M 
## Wald test p-value: pna O vs M 
## DataFrame with 11 rows and 6 columns
##            baseMean log2FoldChange     lfcSE        stat      pvalue       padj
##           &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;  &lt;numeric&gt;
## Topic_1   860.20984    -0.00301489  1.571767 -0.00191815 0.998469536 0.99846954
## Topic_2  1040.00766    -0.23883154  1.489550 -0.16033804 0.872614794 0.99846954
## Topic_3     4.72578    -1.96488007  1.042164 -1.88538517 0.059377854 0.16328910
## Topic_4   180.11478     4.32606625  1.204541  3.59146455 0.000328825 0.00361707
## Topic_5    27.56455     2.23657681  1.180879  1.89399299 0.058225941 0.16328910
## Topic_6     6.67586     0.09843585  0.881377  0.11168412 0.911073873 0.99846954
## Topic_7     5.19734    -0.59432231  0.892778 -0.66569966 0.505603089 0.79451914
## Topic_8   425.39352     0.63277929  1.509760  0.41912576 0.675124224 0.92829581
## Topic_9  2991.31585    -2.69366584  1.665720 -1.61711797 0.105852819 0.19406350
## Topic_10 1417.10667     2.41994794  1.495368  1.61829572 0.105598883 0.19406350
## Topic_11   33.61182     3.26394880  1.158670  2.81697937 0.004847764 0.02666270</code></pre>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#writeResTable(res, fileN = paste0("dds_all_paired_nonaster_", K,".tex"))</span></code></pre></div>
</div>
<div id="test-on-paired-aster-specimens" class="section level3">
<h3 class="hasAnchor">
<a href="#test-on-paired-aster-specimens" class="anchor"></a>Test on paired Aster specimens</h3>
<p>We do the test on paired Aster specimens.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeqDataSet.html">DESeqDataSetFromMatrix</a></span><span class="op">(</span>
  countData <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/phyloseq/man/transpose-methods.html">t</a></span><span class="op">(</span><span class="va">median_theta_aligned_abun</span><span class="op">)</span>,
  colData <span class="op">=</span> <span class="va">sam_data</span>,
  design<span class="op">=</span> <span class="op">~</span>  <span class="va">pna</span>
  <span class="op">)</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="va">dds</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="va">dds</span><span class="op">$</span><span class="va">X</span><span class="op">)</span> <span class="op">%in%</span> <span class="va">paired_aster</span><span class="op">]</span>

<span class="va">dds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/DESeq.html">DESeq</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  fitType <span class="op">=</span> <span class="st">"mean"</span>
  <span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span>
  <span class="va">dds</span>, 
  file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"dds_all_paired_aster_K_"</span>, <span class="va">K</span>,<span class="st">".rds"</span><span class="op">)</span>
  <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"dds_all_paired_aster_K_11"</span><span class="op">)</span>
<span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/DESeq2/man/results.html">results</a></span><span class="op">(</span><span class="va">dds_all_paired_aster_K_11</span><span class="op">)</span>
<span class="va">res</span> </code></pre></div>
<pre><code>## log2 fold change (MLE): pna O vs M 
## Wald test p-value: pna O vs M 
## DataFrame with 11 rows and 6 columns
##           baseMean log2FoldChange     lfcSE       stat      pvalue        padj
##          &lt;numeric&gt;      &lt;numeric&gt; &lt;numeric&gt;  &lt;numeric&gt;   &lt;numeric&gt;   &lt;numeric&gt;
## Topic_1  6218.5368    -10.4304467   1.51290 -6.8943421 5.41147e-12 5.95261e-11
## Topic_2   808.8041      1.2913524   1.35518  0.9529025 3.40639e-01 6.24506e-01
## Topic_3    62.3447      0.5769415   1.41106  0.4088702 6.82635e-01 8.34332e-01
## Topic_4  3197.9976      0.9723636   1.53691  0.6326749 5.26946e-01 8.28058e-01
## Topic_5    10.5337     -0.1502755   1.27513 -0.1178511 9.06186e-01 9.48164e-01
## Topic_6   188.5282      0.0862107   1.32605  0.0650131 9.48164e-01 9.48164e-01
## Topic_7    20.2758      0.4522516   1.03245  0.4380355 6.61361e-01 8.34332e-01
## Topic_8    12.0123     -1.3189221   1.02924 -1.2814486 2.00036e-01 4.52427e-01
## Topic_9  1035.0590     -7.8134758   1.32604 -5.8923438 3.80756e-09 1.39610e-08
## Topic_10  129.1210     -1.5272929   1.20675 -1.2656214 2.05649e-01 4.52427e-01
## Topic_11 2344.2823      8.3837719   1.38843  6.0383030 1.55743e-09 8.56589e-09</code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#writeResTable(res, fileN = paste0("dds_all_paired_aster_", K,".tex"))</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Pratheepa Jeganathan, Susan Holmes.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
